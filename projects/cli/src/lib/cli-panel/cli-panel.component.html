<collapsable-content
  [isCollapsed]="options?.isCollapsed ?? true"
  (onToggle)="onToggle($event)"
  (onContentSizeChange)="onContentSizeChange($event)"
  *ngIf="visible"
>
  <ng-container *ngIf="initialized">
    <div class="terminal-tabs">
      <ul class="tab-list">
        <li
          *ngFor="let tab of tabs; trackBy: trackByTabId"
          class="tab"
          [class.active]="tab.id === activeTabId"
          (click)="selectTab(tab.id)"
          (dblclick)="onTabDoubleClick(tab)"
          (contextmenu)="onTabContextMenu($event, tab)"
        >
          <input
            *ngIf="tab.isEditing"
            class="tab-rename-input"
            type="text"
            [value]="tab.title"
            (keydown)="onRenameKeydown($event, tab)"
            (blur)="onRenameBlur($event, tab)"
            (click)="$event.stopPropagation()"
            (dblclick)="$event.stopPropagation()"
            #renameInput
          />
          <span *ngIf="!tab.isEditing" class="tab-title">{{ tab.title }}</span>
          <button
            *ngIf="!tab.isEditing"
            class="close-btn"
            title="Close tab"
            (click)="closeTab(tab.id); $event.stopPropagation()"
          >
            &times;
          </button>
        </li>
      </ul>
      <button class="add-tab" title="New terminal" (click)="addTab()">+</button>
    </div>
    <div class="terminal-instances">
      <div
        *ngFor="let tab of tabs; trackBy: trackByTabId"
        class="terminal-instance"
        [hidden]="tab.id !== activeTabId"
      >
        <div class="terminal-panes-container" [attr.data-tab-id]="tab.id"
             [class.resizing]="paneResizing">
          <ng-container *ngFor="let pane of tab.panes; let i = index; trackBy: trackByPaneId">
            <div *ngIf="i > 0" class="pane-divider"
                 (mousedown)="onPaneResizeStart($event, tab.id, i - 1)">
              <div class="pane-divider-grip"></div>
            </div>
            <div class="terminal-pane"
                 [class.active-pane]="pane.id === activePaneId && tab.id === activeTabId"
                 [style.flex]="pane.widthPercent + ' 1 0'"
                 (click)="onPaneClick(tab.id, pane.id)">
              <button *ngIf="tab.panes.length > 1" class="pane-close-btn"
                      (click)="closePane(tab.id, pane.id); $event.stopPropagation()"
                      title="Close pane">&times;</button>
              <cli [options]="options" [height]="terminalHeight" />
            </div>
          </ng-container>
        </div>
      </div>
    </div>
  </ng-container>
</collapsable-content>

<!-- Context menu rendered outside collapsable-content to escape transform/overflow clipping -->
<div
  class="tab-context-menu"
  *ngIf="contextMenu.visible"
  [style.left.px]="contextMenu.x"
  [style.top.px]="contextMenu.y"
  (click)="$event.stopPropagation()"
>
  <button class="context-menu-item" (click)="contextMenuRename()">Rename</button>
  <button class="context-menu-item" (click)="contextMenuDuplicate()">Duplicate</button>
  <button class="context-menu-item" (click)="contextMenuSplitRight()">Split Right</button>
  <div class="context-menu-separator"></div>
  <button class="context-menu-item" (click)="contextMenuClose()">Close</button>
  <button class="context-menu-item" (click)="contextMenuCloseOthers()" [disabled]="tabs.length <= 1">Close Others</button>
  <button class="context-menu-item" (click)="contextMenuCloseToTheRight()">Close to the Right</button>
  <div class="context-menu-separator"></div>
  <button class="context-menu-item destructive" (click)="contextMenuCloseAll()">Close All</button>
</div>
